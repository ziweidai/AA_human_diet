%--------------------------------------------------------------------------
% Load dietary, clinical and demographic datasets from 2007-2014 NHANES
% datasets
%--------------------------------------------------------------------------
% **Notice**: Run R scripts 'ProcessNHANES.R' and 'AA_Imputation.R' to
% generate the necessary input files before running this script
%--------------------------------------------------------------------------

%% Read NHANES nutrient intake datasets generated by ProcessNHANES.R
x=readtable('NHANES_Nutrients.csv','ReadRowNames',true,'ReadVariableNames',true);
NutIDs_NHANES = {'tzinc','tp182','tff','tmfat','tcaff','tp183','tvk','ts160',...
    'tcarb','ttheo','tfibe','tniac','ttfat','tvb2','tiron','tcopp',...
    'tfdfe','tphos','tcalc','tchl','tsugr','tvc','tpfat','tvara','tvb12',...
    'tatoc','tvb1','tvb6','tm181','tsodi','tsele','tmagn','tprot',...
    'tkcal','ts180','tsfat','tpota','tvd','tfa'};
NutAlias_NHANES = {'Zinc(mg)','PFA 18:2(Octadecadienoic)(gm)','Food folate(mcg)',...
              'Total monounsaturated fatty acids(gm)','Caffeine(mg)',...
              'PFA 18:3(Octadecatrienoic)(gm)','Vitamin K(mcg)',...
              'SFA 16:0(Hexadecanoic)(gm)','Carbohydrate(gm)','Theobromine(mg)',...
              'Dietary fiber(gm)','Niacin(mg)','Total fat(gm)',...
              'Riboflavin (Vitamin B2)(mg)','Iron(mg)','Copper(mg)',...
              'Folate,DFE(mcg)','Phosphorus(mg)','Calcium(mg)',...
              'Total choline(mg)','Total sugars(gm)','Vitamin C(mg)',...
              'Total polyunsaturated fatty acids(gm)','Vitamin A,RAE(mcg)',...
              'Vitamin B12(mcg)','Vitamin E as alpha-tocopherol(mg)',...
              'Thiamin(Vitamin B1)(mg)','Vitamin B6(mg)',...
              'MFA 18:1 (Octadecenoic)(gm)','Sodium(mg)','Selenium(mcg)',...
              'Magnesium(mg)','Protein(gm)','Energy(kcal)',...
              'SFA 18:0(Octadecanoic)(gm)','Total saturated fatty acids(gm)',...
              'Potassium(mg)','Vitamin D(D2+D3)(mcg)','Folic acid(mcg)'};
Mat_Nutrients_Raw=table2array(x(:,NutIDs_NHANES));
seqn=table2array(x(:,1));
counttable=tabulate(seqn);
pID_keep=counttable(counttable(:,2)==2,1);
clear counttable x

%% Calculate nutritional values averaged over the two days
Mat_NutFood_NHANES=zeros(length(pID_keep),39);
for i=1:length(pID_keep)
    Mat_NutFood_NHANES(i,:)=mean(Mat_Nutrients_Raw(ismember(seqn,pID_keep(i)),:));
end
clear Mat_Nutrients_Raw

%% Read nutrient intake from dietary supplements
x=readtable('DietSupp.csv','ReadRowNames',true,'ReadVariableNames',true,...
    'TreatAsEmpty','NA');
names1=strcat('ds1',NutIDs_NHANES);
names2=strcat('ds2',NutIDs_NHANES);
y=zeros(size(x,1),39);
y(:,ismember(names1,x.Properties.VariableNames))=...
    table2array(x(:,names1(ismember(names1,x.Properties.VariableNames))))/2+...
    table2array(x(:,names2(ismember(names2,x.Properties.VariableNames))))/2;
seqn_supp=str2num(cell2mat(x.Properties.RowNames));
[~,pos]=ismember(pID_keep,seqn_supp);
Mat_NutSupp_NHANES=zeros(size(Mat_NutFood_NHANES,1),length(NutIDs_NHANES));
Mat_NutSupp_NHANES(pos>0,:)=y(pos(pos>0),:);
Mat_NutSupp_NHANES(isnan(Mat_NutSupp_NHANES))=0;

Mat_NutTotal_NHANES = Mat_NutFood_NHANES + Mat_NutSupp_NHANES;
clear names1 names2 seqn_supp pos x y

%% Read demographic data from Demo.csv generated by ProcessNHANES.R
x=readtable('Demo.csv','ReadRowNames',true,'ReadVariableNames',true,...
    'TreatAsEmpty','NA');
seqn_demo=str2num(cell2mat(x.Properties.RowNames));
Demo=x(ismember(seqn_demo,pID_keep),:);
clear x seqn_demo

%% Read clinical and other variables from ClinVars.csv generated by ProcessNHANES.R
x=readtable('ClinVars.csv','ReadRowNames',true,'ReadVariableNames',true,...
    'TreatAsEmpty','NA');
seqn_clinvars=str2num(cell2mat(x.Properties.RowNames));
ClinVars=x(ismember(seqn_clinvars,pID_keep),:);
clear x seqn_clinvars

%% Read imputed amino acid intake data from NHANES_reconstructed_D12.csv generated by AA_Imputation.R
x = readtable('NHANES_reconstructed_D12.csv','TreatAsEmpty','NA');
seqn_rec = str2double(table2array(x(:,1))); 
AA_Rec=zeros(length(pID_keep),18);
[~,pos]=ismember(pID_keep,seqn_rec);
AA_Rec(pos>0,:)=table2array(x(pos(pos>0),48:65));
AA_Prot_Ratio_Rec = AA_Rec./sum(AA_Rec')';
AA_Prot_Ratio_Rec(sum(AA_Rec,2)==0,:)=0;
AANames_NHANES = {'Tryptophan','Threonine','Isoleucine','Leucine',...
    'Lysine','Methionine','Cystine','Phenylalanine','Tyrosine',...
    'Valine','Arginine','Histidine','Alanine','Aspartate+Asparagine',...
    'Glutamate+Glutamine','Glycine','Proline','Serine'};
clear x pos seqn_rec


%% Define potential confounders
% Age
Age=table2array(Demo(:,'ridagemn'))/12;
Age(isnan(Age))=table2array(Demo(isnan(Age),'ridageyr'));

% Gender
Gender=table2array(Demo(:,'riagendr'));

% Batch (2007-2008, 2009-2010, 2011-2012, 2013-2014)
Batch=ones(30899,1);
Batch(pID_keep>71916)=4;
Batch(pID_keep>62160 & pID_keep<=71916)=3;
Batch(pID_keep>51623 & pID_keep<=62160)=2;

% Annual family income
Income=table2array(Demo(:,'indfmin2'));
Income(Income==77)=NaN;
Income(Income==99)=NaN;
%Estimate income using approximate median income value in this income group
MidIncomeTable=[1 2 3 4 5 6 7 8 9 10 12 13 14 15;...
    2500 7500 12500 17500 22500 30000 40000 50000 60000 70000 50000 10000 87500 100000];
for i=1:14
    Income(Income==MidIncomeTable(1,i))=MidIncomeTable(2,i);
end
clear MidIncomeTable

% Educational level
EduAdult=table2array(Demo(:,'dmdeduc2'));
EduAdult(EduAdult==7)=NaN;
EduAdult(EduAdult==9)=NaN;
EduChild=table2array(Demo(:,'dmdeduc3'));
EduChild(EduChild<9)=1;
EduChild(EduChild>=9 & EduChild<=12)=2;
EduChild(EduChild==13 | EduChild==14)=3;
EduChild(EduChild==15)=4;
EduChild(EduChild==55 | EduChild==66)=1;
EduChild(EduChild==77 | EduChild==99)=NaN;
Education=EduAdult;
Education(isnan(Education))=EduChild(isnan(Education));
clear EduAdult EduChild

% Race/Ethnicity
Race=full(sparse(1:length(pID_keep),table2array(Demo(:,'ridreth1')),ones(length(pID_keep),1)));

% Marital status
% 0 - Single/widowed/divorced/separated
% 1 - Married/living with partner
MaritalTag=table2array(Demo(:,'dmdmartl'));
MaritalTag(MaritalTag==77 | MaritalTag==99 | isnan(MaritalTag))=NaN;
MaritalTag(MaritalTag==2 | MaritalTag==3 | MaritalTag==4 | MaritalTag==5)=0; 
MaritalTag(MaritalTag==6)=1;
MaritalTag(Age<20)=NaN;
MaritalStatus=MaritalTag;
clear MaritalTag

% Smoking history:
% 1 - has smoked at least 100 cigarettes during lifetime; 2 - no
Smoking=table2array(ClinVars(:,'smq020'));
Smoking(Smoking == 7 | Smoking == 9)=NaN;

% Alcohol consumption
% 1 - had >12 alcoholic drinks per year; 2 - no; 7 - refused; 9 - don't
% know
Alcohol=table2array(ClinVars(:,'alq101'));
Alcohol(Alcohol == 7 | Alcohol == 9) = NaN;

% Physical activity
% Vigorous work activity
PA1=table2array(ClinVars(:,'paq605'));
PA1(PA1~=1)=0;
% Moderate work activity
PA2=table2array(ClinVars(:,'paq620'));
PA2(PA2~=1)=0;
% Bicycle or walk to work
PA3=table2array(ClinVars(:,'paq635'));
PA3(PA3~=1)=0;
% Vigorous recreational activities
PA4=table2array(ClinVars(:,'paq650'));
PA4(PA4~=1)=0;
% Moderate recreational activities
PA5=table2array(ClinVars(:,'paq655'));
PA5(PA5~=1)=0;
% Overall physical activity score
PhysicalActivity=PA1*2+PA4*2+PA2+PA3+PA5;
clear PA1 PA2 PA3 PA4 PA5

% Total energy intake
Energy=Mat_NutTotal_NHANES(:,34);

% BMI
BMI=table2array(ClinVars(:,'bmxbmi'));
